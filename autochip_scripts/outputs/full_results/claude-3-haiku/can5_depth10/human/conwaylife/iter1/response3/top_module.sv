module top_module(
    input clk,
    input load,
    input [255:0] data,
    output reg [255:0] q
);

always @(posedge clk) begin
    if (load) begin
        q <= data;
    end
    else begin
        // Circular shift the grid by one row
        q[255:240] <= {q[239:224], q[15:0]};
        q[239:224] <= {q[223:208], q[31:16]};
        q[223:208] <= {q[207:192], q[47:32]};
        q[207:192] <= {q[191:176], q[63:48]};
        q[191:176] <= {q[175:160], q[79:64]};
        q[175:160] <= {q[159:144], q[95:80]};
        q[159:144] <= {q[143:128], q[111:96]};
        q[143:128] <= {q[127:112], q[127:112]};
        q[127:112] <= {q[111:96], q[143:128]};
        q[111:96] <= {q[95:80], q[159:144]};
        q[95:80] <= {q[79:64], q[175:160]};
        q[79:64] <= {q[63:48], q[191:176]};
        q[63:48] <= {q[47:32], q[207:192]};
        q[47:32] <= {q[31:16], q[223:208]};
        q[31:16] <= {q[15:0], q[239:224]};
        q[15:0] <= {q[255:240], q[15:0]};

        // Apply the cellular automata rules
        q[255:240] <= (q[255:240] == 3'b010 || (q[255:240] == 3'b111 && (q[239:224] + q[223:208] + q[207:192] + q[191:176] + q[175:160] + q[159:144] + q[143:128] + q[127:112]) == 3)) ? 3'b111 : 3'b000;
        q[239:224] <= (q[239:224] == 3'b001 || (q[239:224] == 3'b111 && (q[255:240] + q[223:208] + q[207:192] + q[191:176] + q[175:160] + q[159:144] + q[143:128] + q[111:96]) == 3)) ? 3'b111 : 3'b000;
        q[223:208] <= (q[223:208] == 3'b010 || (q[223:208] == 3'b111 && (q[255:240] + q[239:224] + q[207:192] + q[191:176] + q[175:160] + q[159:144] + q[127:112] + q[31:16]) == 3)) ? 3'b111 : 3'b000;
        q[207:192] <= (q[207:192] == 3'b000 || (q[207:192] == 3'b111 && (q[255:240] + q[239:224] + q[223:208] + q[191:176] + q[175:160] + q[143:128] + q[47:32] + q[15:0]) == 3)) ? 3'b111 : 3'b000;
        q[191:176] <= (q[191:176] == 3'b000 || (q[191:176] == 3'b111 && (q[255:240] + q[239:224] + q[223:208] + q[207:192] + q[159:144] + q[63:48] + q[31:16]) == 3)) ? 3'b111 : 3'b000;
        q[175:160] <= (q[175:160] == 3'b000 || (q[175:160] == 3'b111 && (q[255:240] + q[239:224] + q[223:208] + q[143:128] + q[79:64] + q[47:32]) == 3)) ? 3'b111 : 3'b000;
        q[159:144] <= (q[159:144] == 3'b000 || (q[159:144] == 3'b111 && (q[255:240] + q[239:224] + q[207:192] + q[159:144] + q[95:80] + q[63:48]) == 3)) ? 3'b111 : 3'b000;
        q[143:128] <= (q[143:128] == 3'b000 || (q[143:128] == 3'b111 && (q[255:240] + q[223:208] + q[191:176] + q[111:96] + q[79:64]) == 3)) ? 3'b111 : 3'b000;
    end
end

endmodule
